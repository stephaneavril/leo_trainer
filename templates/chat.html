<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sesi√≥n con Leo</title>
  <style>
    body {
      background-color: #0c0e2c;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      padding: 30px;
      text-align: center;
    }

    h1 {
      color: #00bfff;
    }

    #chat-container {
      margin-top: 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .message {
      background: #222;
      padding: 10px 15px;
      border-radius: 8px;
      margin: 5px;
      max-width: 600px;
      text-align: left;
    }

    .user { align-self: flex-end; background: #00bfff; color: black; }
    .leo  { align-self: flex-start; background: #333; }

    #ai-agent {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }

    #end-btn {
      margin-top: 40px;
      padding: 12px 30px;
      font-size: 16px;
      background: red;
      border: none;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      display: none;
    }

    #confirmation {
      display: none;
      margin-top: 50px;
      font-size: 20px;
      color: #00ffcc;
      animation: fadeIn 1s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>

  <h1>üß† Leo - {{ scenario }}</h1>
  <p id="status">Solicitando permisos para c√°mara y micr√≥fono...</p>

  <div id="chat-container"></div>
  <button id="end-btn">Finalizar sesi√≥n</button>

  <div id="ai-agent"></div>
  <div id="confirmation">‚úÖ ¬°Gracias por tu participaci√≥n! Tu sesi√≥n ha sido registrada correctamente.</div>

  <script type="module">
    document.addEventListener("DOMContentLoaded", async () => {
      const name = "{{ name }}";
      const email = "{{ email }}";
      const scenario = "{{ scenario }}";

      const status = document.getElementById("status");
      const endBtn = document.getElementById("end-btn");
      const confirmation = document.getElementById("confirmation");

      let recorder;
      let chunks = [];
      let stream;
      let agent;

      try {
        stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
        console.log("‚úÖ Permiso de c√°mara/micr√≥fono concedido");
        status.textContent = "Permiso concedido. Iniciando sesi√≥n con Leo...";

        const preview = document.createElement('video');
        preview.srcObject = stream;
        preview.autoplay = true;
        preview.muted = true;
        preview.style.width = '200px';
        preview.style.position = 'fixed';
        preview.style.bottom = '20px';
        preview.style.left = '20px';
        preview.id = 'preview-video';
        document.body.appendChild(preview);

        recorder = new MediaRecorder(stream);
        recorder.ondataavailable = e => {
          if (e.data.size > 0) chunks.push(e.data);
        };

        recorder.onstop = async () => {
          const blob = new Blob(chunks, { type: 'video/webm' });
          const formData = new FormData();
          formData.append('video', blob);
          formData.append('name', name);
          formData.append('email', email);

          await fetch('/upload_video', {
            method: 'POST',
            body: formData
          });

          confirmation.style.display = 'block';
          setTimeout(() => {
            window.location.href = "/";
          }, 4000);
        };

        recorder.start();
        console.log("üé• Grabaci√≥n iniciada");
        endBtn.style.display = "inline-block";

        let lastInput = "";
        const container = document.getElementById("chat-container");

        const DIDAgentModule = await import('https://agent.d-id.com/v1/index.js');
        agent = new DIDAgentModule.Agent({
          name: 'Leo',
          mode: 'fabio',
          agentId: 'agt_8nBIc-s-',
          clientKey: 'Z29vZ2xlLW9hdXRoMnwxMDM4NDYxNzYzNTI0NDE3NDc2NDY6MFR2bThhSXJ0QlhEZENCdmdBTkNN',
          stream: true,
          voice: { lang: 'es-ES' }
        });

        agent.mount(document.getElementById("ai-agent"));
        agent.on('input', (text) => {
          lastInput = text;
          const userMsg = document.createElement("div");
          userMsg.className = "message user";
          userMsg.textContent = text;
          container.appendChild(userMsg);
        });

        agent.on('response', async (text) => {
          const leoMsg = document.createElement("div");
          leoMsg.className = "message leo";
          leoMsg.textContent = text;
          container.appendChild(leoMsg);

          await fetch('/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name: name,
              email: email,
              message: lastInput,
              response: text,
              scenario: scenario
            })
          });
        });

        agent.start();
        console.log("üü¢ Leo iniciado");

        endBtn.addEventListener("click", () => {
          if (recorder && recorder.state === "recording") {
            console.log("üì§ Deteniendo grabaci√≥n y limpiando...");
            recorder.stop();
            endBtn.disabled = true;
            endBtn.textContent = "Guardando...";

            if (agent && agent.unmount) {
              agent.unmount();
              console.log("üßπ Leo desmontado");
            }

            document.getElementById("ai-agent").innerHTML = "";
            const preview = document.getElementById("preview-video");
            if (preview) preview.remove();

            stream.getTracks().forEach(track => track.stop());
            console.log("üõë C√°mara y micr√≥fono detenidos");
          } else {
            console.warn("‚õî No se est√° grabando. Estado:", recorder?.state);
            alert("No se est√° grabando actualmente.");
          }
        });

      } catch (err) {
        console.error("‚ùå Acceso denegado o error de permisos:", err);
        status.textContent = "‚ùå No se pudo acceder a tu c√°mara/micr√≥fono. Debes permitir acceso para continuar.";
        alert("Por favor permite acceso a c√°mara y micr√≥fono en tu navegador.");
      }
    });
  </script>
</body>
</html>
