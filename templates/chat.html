<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sesi√≥n con Leo</title>
  <style>
    body {
      background-color: #0c0e2c;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      padding: 30px;
      text-align: center;
    }

    h1 {
      color: #00bfff;
    }

    #chat-container {
      margin-top: 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .message {
      background: #222;
      padding: 10px 15px;
      border-radius: 8px;
      margin: 5px;
      max-width: 600px;
      text-align: left;
    }

    .user { align-self: flex-end; background: #00bfff; color: black; }
    .leo  { align-self: flex-start; background: #333; }

    #end-btn, #timer, #to-dashboard {
      margin-top: 30px;
      padding: 12px 30px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
    }

    #end-btn {
      background: red;
      border: none;
      color: white;
    }

    #timer {
      background-color: #222;
      color: #00ffcc;
      border: 2px solid #00bfff;
    }

    #to-dashboard {
      background: #00bfff;
      color: white;
      border: none;
      display: none;
    }

    #summary-box {
      display: none;
      margin-top: 50px;
      background-color: #1f1f3a;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px #000a;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
    }

    #summary-box h2 {
      color: #00ffcc;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

  <h1>üß† Leo - {{ scenario }}</h1>
  <p id="status">Solicitando permisos para c√°mara y micr√≥fono...</p>

  <div id="chat-container"></div>
  <button id="end-btn">Finalizar sesi√≥n</button>
  <div id="timer">Duraci√≥n: 05:00</div>

  <div id="summary-box">
    <h2>‚úÖ Resumen de desempe√±o</h2>
    <p id="evaluation-text"></p>
    <form id="dashboardForm" action="/dashboard" method="POST">
      <input type="hidden" name="name" value="{{ name }}">
      <input type="hidden" name="email" value="{{ email }}">
      <button id="to-dashboard" type="submit">Ver mi progreso</button>
    </form>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const name = "{{ name }}";
      const email = "{{ email }}";
      const scenario = "{{ scenario }}";

      const endBtn = document.getElementById("end-btn");
      const chat = document.getElementById("chat-container");
      const summaryBox = document.getElementById("summary-box");
      const evalText = document.getElementById("evaluation-text");
      const status = document.getElementById("status");
      const timerEl = document.getElementById("timer");
      const dashBtn = document.getElementById("to-dashboard");

      let recorder, chunks = [], stream, messages = [];
      let sessionEnded = false;

      const updateTimer = (duration) => {
        const minutes = Math.floor(duration / 60).toString().padStart(2, '0');
        const seconds = (duration % 60).toString().padStart(2, '0');
        timerEl.textContent = `Duraci√≥n: ${minutes}:${seconds}`;
      }

      const endSession = async () => {
        if (sessionEnded) return;
        sessionEnded = true;

        endBtn.disabled = true;
        endBtn.textContent = "Guardando...";
        stream.getTracks().forEach(track => track.stop());
        document.getElementById("preview-video")?.remove();

        recorder.stop();
        const blob = new Blob(chunks, { type: 'video/webm' });
        const formData = new FormData();
        formData.append('video', blob);
        formData.append('name', name);
        formData.append('email', email);
        await fetch('/upload_video', { method: 'POST', body: formData });

        const res = await fetch('/log_full_session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, scenario, conversation: messages })
        });

        const data = await res.json();
        summaryBox.style.display = 'block';
        evalText.textContent = data.evaluation || "Evaluaci√≥n no disponible.";
        endBtn.style.display = "none";
        timerEl.style.display = "none";
        dashBtn.style.display = "inline-block";
      };

      try {
        stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
      } catch (err) {
        console.error("‚ùå Error accediendo a medios:", err);
        status.textContent = "‚ùå No se pudo acceder a tu c√°mara/micr√≥fono. Debes permitir acceso.";
        return;
      }

      const preview = document.createElement("video");
      preview.srcObject = stream;
      preview.autoplay = true;
      preview.muted = true;
      preview.style.width = "200px";
      preview.style.position = "fixed";
      preview.style.bottom = "20px";
      preview.style.left = "20px";
      preview.id = "preview-video";
      document.body.appendChild(preview);

      status.textContent = "Permiso concedido. Grabando sesi√≥n...";
      recorder = new MediaRecorder(stream);
      recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
      recorder.start();

      function mockLeoResponse(text) {
        const userMsg = document.createElement("div");
        userMsg.className = "message user";
        userMsg.textContent = text;
        chat.appendChild(userMsg);
        messages.push({ role: "user", text });

        const response = "Gracias por tu respuesta. ¬øC√≥mo manejar√≠as la objeci√≥n del paciente?";
        const leoMsg = document.createElement("div");
        leoMsg.className = "message leo";
        leoMsg.textContent = response;
        chat.appendChild(leoMsg);
        messages.push({ role: "leo", text: response });
      }

      mockLeoResponse("Inicio de la sesi√≥n");

      endBtn.addEventListener("click", endSession);

      let countdown = 300; // 5 minutos
      const interval = setInterval(() => {
        countdown--;
        updateTimer(countdown);
        if (countdown <= 0) {
          clearInterval(interval);
          endSession();
        }
      }, 1000);
    });
  </script>
</body>
</html>
